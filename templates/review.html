<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Slip OCR / LLM Extractor</title>
<style>
  :root{
    --bg:#0b1020; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
    --primary:#22d3ee; --primary-2:#38bdf8; --ok:#22c55e; --border:#1f2a44;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
    Roboto, "Noto Sans Thai", Inter, "Helvetica Neue", Arial, sans-serif;
    background:linear-gradient(180deg, #0a0f1f 0%, #0b1020 100%);
    color:var(--text);
  }
  .wrap{max-width:980px;margin:40px auto;padding:0 20px}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn:active{transform:translateY(1px)}
  .row{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:14px}
  .preview{display:flex;justify-content:center;margin-top:14px}
  .preview img{max-height:280px; max-width:100%; border-radius:12px; border:1px solid var(--border)}
  .hint{font-size:12px;color:var(--muted); margin-top:6px}

  .panel{background:#0a1327;border:1px solid var(--border);border-radius:12px;padding:14px}
  pre{
    margin:0; background:#0a1327; color:#e5eefc; border-radius:10px; padding:16px;
    overflow:auto; max-height:520px; font-size:13.5px; line-height:1.45;
  }
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
  .ok{color:var(--ok)}
  .spinner{width:16px;height:16px;border:2px solid #69e2ff;border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin .8s linear infinite;margin-right:6px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .actions{display:flex;gap:10px;margin-top:10px}
  .ghost{background:#0d1a33;color:#cfe9ff;border:1px solid var(--border)}
  .footer{margin-top:24px;color:#7a8aa8;font-size:12px;text-align:center}
  code.kv{padding:6px 8px;border-radius:8px;background:#0e1a36;border:1px solid var(--border)}
  /* overlay while waiting for bank DB to update */
  .waitOverlay{
    position:fixed; inset:0; display:flex;align-items:center;justify-content:center;z-index:1200;
    background:rgba(2,6,23,0.6); backdrop-filter: blur(3px);
  }
  .waitCard{background:linear-gradient(180deg,#071028,#081526);padding:20px;border-radius:12px;border:1px solid #20324a;color:#e6f7ff;min-width:320px;text-align:center}
  .waitCount{font-size:44px;font-weight:700;margin:6px 0}
  .waitMsg{color:#a3b6d0;margin-top:6px}
  .waitBar{height:8px;background:#062036;border-radius:8px;overflow:hidden;margin-top:12px}
  .waitBarInner{height:100%;background:linear-gradient(90deg,#22d3ee,#38bdf8);width:0%}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">Slip Extractor <span class="badge">LLM Ready</span></div>
      <div class="chips">
        <div class="chip">ไทย/อังกฤษ</div>
        <div class="chip">รองรับหลายธนาคาร</div>
        <div class="chip">JSON Output</div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Uploader -->
      <div class="card">
        <div class="drop" id="drop">
          <svg width="44" height="44" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 6v12m6-6H6" stroke="#7dd3fc" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <h3>ลากรูปสลิปมาวางที่นี่</h3>
          <div class="muted">หรือ</div>
          <div class="row">
            <label class="btn" for="file">เลือกไฟล์</label>
            <input id="file" type="file" accept="image/png, image/jpeg" />
          </div>
          <div class="hint">รองรับ .jpg / .png ขนาดไม่เกิน ~15MB</div>
          <div class="preview" id="preview" hidden></div>
          <div class="row">
            <button id="analyze" class="btn" disabled>วิเคราะห์</button>
            <button id="reset" class="btn ghost" type="button" hidden>ล้างค่า</button>
          </div>
          <div class="hint" id="status"></div>
        </div>
      </div>

      <!-- Right: Output -->
      <div class="card">
        <div class="panel">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
            <div class="muted">ผลลัพธ์</div>
            <div class="actions">
              <button id="copy" class="btn ghost" type="button">คัดลอก JSON</button>
              <button id="download" class="btn ghost" type="button">ดาวน์โหลด .json</button>
            </div>
          </div>
          <pre id="out">{}</pre>
        </div>

        <div class="panel" style="margin-top:12px">
          <div class="muted" style="margin-bottom:6px">สถานะ</div>
          <div id="pillars">
            <span>API: <code class="kv" id="apiStat">รออัปโหลด</code></span>
            <span style="margin-left:10px">โหมด: <code class="kv" id="mode">ไม่ทราบ</code></span>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      ทำงานร่วมกับ LLM (GPT-4o mini) หรือ Tesseract ตามการตั้งค่าใน <code class="kv">.env</code>
    </div>
  </div>

<script>
(function(){
  const fileInput = document.getElementById('file');
  const drop = document.getElementById('drop');
  const preview = document.getElementById('preview');
  const analyzeBtn = document.getElementById('analyze');
  const resetBtn = document.getElementById('reset');
  const out = document.getElementById('out');
  const statusEl = document.getElementById('status');
  const apiStat = document.getElementById('apiStat');
  const modeEl = document.getElementById('mode');
  const copyBtn = document.getElementById('copy');
  const downloadBtn = document.getElementById('download');

  let pickedFile = null;

  // drag & drop
  ['dragenter','dragover'].forEach(evt => {
    drop.addEventListener(evt, e => { e.preventDefault(); drop.style.borderColor = '#3a5fa5'; });
  });
  ['dragleave','drop'].forEach(evt => {
    drop.addEventListener(evt, e => { e.preventDefault(); drop.style.borderColor = '#2a3a60'; });
  });
  drop.addEventListener('drop', e => {
    const f = e.dataTransfer.files?.[0];
    if (f) setFile(f);
  });

  fileInput.addEventListener('change', e => {
    const f = e.target.files?.[0];
    if (f) setFile(f);
  });

  function setFile(f){
    pickedFile = f;
    analyzeBtn.disabled = false;
    resetBtn.hidden = false;
    const url = URL.createObjectURL(f);
    preview.innerHTML = `<img src="${url}" alt="preview">`;
    preview.hidden = false;
    status('เลือกไฟล์แล้ว', 'ok');
  }

  resetBtn.addEventListener('click', ()=>{
    pickedFile = null;
    fileInput.value = '';
    preview.hidden = true;
    preview.innerHTML = '';
    out.textContent = '{}';
    analyzeBtn.disabled = true;
    resetBtn.hidden = true;
    status('รออัปโหลด', null);
    apiStat.textContent = 'รออัปโหลด';
    modeEl.textContent = 'ไม่ทราบ';
  });

    analyzeBtn.addEventListener('click', async ()=>{
      if (!pickedFile) return;
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = `<span class="spinner"></span>Preparing...`;
      status('อัปโหลดไฟล์และวิเคราะห์...', null);
      apiStat.textContent = 'กำลังส่งคำขอ...';

      try{
        const fd = new FormData();
        fd.append('file', pickedFile);

  // Short fetch timeout so UI doesn't hang forever (increased for hosted deployments)
  const controller = new AbortController();
  const FETCH_TIMEOUT_MS = 60_000; // 60s
        const fetchTimer = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

        const res = await fetch('/upload', { method:'POST', body: fd, signal: controller.signal });
        clearTimeout(fetchTimer);

        const ct = (res.headers.get('content-type') || '').toLowerCase();
        if (ct.includes('application/json')) {
          const json = await res.json();
          if (json.mode) modeEl.textContent = json.mode.toUpperCase();
          else modeEl.textContent = 'N/A';
          const display = { ocr: json.ocr || json.ocr_parsed || json, db_check: json.db_check || null };
          out.textContent = JSON.stringify(display, null, 2);
          status('สำเร็จ', 'ok');
          apiStat.textContent = 'สำเร็จ';
          try{ localStorage.setItem('last_slip_result', JSON.stringify(display)); }catch(e){}
          // navigate to full result page
          window.location.href = '/result';
          return;
        } else {
          const txt = await res.text();
          out.textContent = JSON.stringify({ error: 'Non-JSON response from server', status: res.status, content_type: ct, body: txt.substring(0, 1500) }, null, 2);
          status('ล้มเหลว: server returned non-JSON response', null);
          apiStat.textContent = 'ล้มเหลว';
        }
      }catch(err){
        out.textContent = JSON.stringify({ error: String(err) }, null, 2);
        status('ล้มเหลว: ' + String(err), null);
        apiStat.textContent = 'ล้มเหลว';
      }finally{
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'วิเคราะห์';
      }
    });

  copyBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(out.textContent);
      status('คัดลอก JSON แล้ว', 'ok');
    }catch(e){
      status('คัดลอกไม่สำเร็จ', null);
    }
  });

  downloadBtn.addEventListener('click', ()=>{
    const blob = new Blob([out.textContent], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'slip_result.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  function status(msg, ok){
    statusEl.innerHTML = ok ? `<span class="ok">●</span> ${msg}` : msg;
  }
})();
</script>
</body>
</html>
